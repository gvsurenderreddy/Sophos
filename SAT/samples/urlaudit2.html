

<!DOCTYPE html>
<html>
<head lang="en">
<meta charset="UTF-8">
<title></title>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
<!--    <script type="text/javascript" src="jquery.ajax-cross-origin.min.js"></script>-->
<link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">

<style type="text/css" id="main">
    #main{
        padding: 20px;
        width: 80%;
        min-height: 800px;
        margin: 0 auto;
    }
    div{
        /*border: 1px solid silver;*/
    }
    table.table-striped tr.tblHeader {
        font-weight: bold;
        background-color: #E0E0E0;
    }
    table.table-striped td:nth-child(1),
    table.table-striped td:nth-child(2){
        width: 350px;
    }
    .results-row {
        overflow: auto;
        margin: 5px;
        /*max-height: 200px;*/
        border-bottom: 1px solid silver;
    }
</style>

<script type="text/javascript">
$(document).ready(function () { //jQuery on ready

    window.onerror=function(){
        logResponse("Windows Error:", arguments, true);
    }

    //------------------- url looper ---------------------------------//
    /*
     TODO:
     1. Append more URL
     2. Include Methods: Ajax, CORS, JSONP
     3. Display Table: URL, Method, Duration, XHR Response, XHR Headers, Response HTML
     */
    $("#urlLooper").on("click", function urlLooper(){
        //clear results...
        $("#clearResults").trigger("click");

        var list = [
            'http://www.abc.com','http://www.peets.com', 'http://www.lasvegas.com', 'http://www.msn.com','http://www.rediff.com','http://www.gmail.com', '../data/1.json',
            'http://www.abc.com','http://www.peets.com', 'http://www.lasvegas.com', 'http://www.msn.com','http://www.rediff.com','http://www.gmail.com', '../data/1.json',
            'http://www.abc.com','http://www.peets.com', 'http://www.lasvegas.com', 'http://www.msn.com','http://www.rediff.com','http://www.gmail.com', '../data/1.json',
            'http://www.abc.com','http://www.peets.com', 'http://www.lasvegas.com', 'http://www.msn.com','http://www.rediff.com','http://www.gmail.com', '../data/1.json'
        ];
        var i;
        var deferreds = [];
        var results = [];
        var additionalUrls = getUrls();

        function doAjax(url,dObject) {
            //var xdata = {json: $.toJSON({name: number}), delay: 1};
            $.ajax({
                url:url,
                timerStart: new Date().getTime(),
                timeout: 5000, // sets timeout to 3 seconds
                type: "GET",
                contentType: 'text/plain',
                crossDomain: true,
                xhrFields: {
                    // The 'xhrFields' property sets additional fields on the XMLHttpRequest.
                    // This can be used to set the 'withCredentials' property.
                    // Set the value to 'true' if you'd like to pass cookies to the server.
                    // If this is enabled, your server must respond with the header
                    // 'Access-Control-Allow-Credentials: true'.
                    withCredentials: false
                },
                headers: {
                    // Set any custom headers here.
                    // If you set any non-simple headers, your server must include these
                    // headers in the 'Access-Control-Allow-Headers' response header.
                },
                complete: function(data) {
                    data.url = this.url;
                    data.timerStart = this.timerStart;
                    data.timerEnd = new Date().getTime();
                    data.timerDuration = (data.timerEnd - data.timerStart),
                            results.push(data);
                    dObject.resolve();
                    //logResponse("urlLooper", 'complete ' + this.url );
                }
            });
        }

        //add additional URLS
        if(additionalUrls.length > 0){
            list = list.concat(additionalUrls);
        }
        //wait spinner .....
        logResponse("Audit status", "Loading and testing " + list.length + " URLs...please wait..... <img class='clsRowSpinner' src='../resources/images/loading.gif'>");

        for(i = 0; i < list.length; i++) {
            var url = list[i];//  + '?' + new Date().getTime();

            var dObject = new $.Deferred();
            deferreds.push(dObject);
            doAjax(url,dObject);
        }

        // check if all ajax calls have finished
        $.when.apply($, deferreds)
                .done(function() {
                    console.log(results);
                    //remove spinner
                    //$(".clsRowSpinner").closest(".results-row").remove();
                    $("#clearResults").trigger("click");

                    var htmlResults = "<table class='table table-striped'>";
                    htmlResults += "<tr class='tblHeader'><td>URL</td><td>XHR Response</td><td>XHR Headers</td></tr>";
                    $.each(results, function(index, resp){
                        htmlResults += "<tr><td>" + resp.url +"</td>" +
                                "<td>" + parseAjaxResp(resp) + "</td>" +
                                "<td>" + dumpHeaders(resp) + "</td>" +
                                "</tr>";
                    });
                    htmlResults += "</table>";
                    try{
                        //Display Final results
                        logResponse("URL Audit Results:" ,  htmlResults);

                    }catch(e){
                        //to handle HTML display errors from ajax resp HTML
                    }
                });//end:done

    });//end - url looper




    //-------------------- JSONP ----------------------------------//
    $("#JSONPTest").on("click", function(){
        var arrUrls = getUrls();
        $.each(arrUrls, function(index, url){
            try{
                // Example URLs with JSONP support
                // https://graph.facebook.com/?ids=http://www.stackoverflow.com
                // https://jsonp.afeld.me/?callback=?&url=http://jsonview.com/example.json

                $.ajax({
                    url: url,
                    jsonp: "callback",
                    dataType: "jsonp",
                    // Work with the response
                    success: function( response, textStatus, jqXHR ) {
                        logResponse("JSONP Test", '<b>' + url + '</b> returns ' + JSON.stringify(response)); // server response
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        logResponse("JSONP Test Error", '<b>' + url + '</b> returns ' + textStatus); // error
                    }
                });//end ajax
            }
            catch(e){
                logResponse("Exception", e);
            }
        });//$.each
    });

    //-------------------------- ajax --------------------------------//
    $("#ajaxTest").on("click", function(){
        var arrUrls = getUrls();
        $.each(arrUrls, function(index, url){
            try{

                var jqxhr = $.ajax(url)
                        .done(function(data, textStatus, jqXHR) {
                            var msg = parseAjaxResp(jqXHR);
                            logResponse("Response:", msg);
                        })
                        .fail(function(jqXHR, textStatus, errorThrown) {
                            var msg = parseAjaxResp(jqXHR);
                            logResponse("Response:", msg);
                        });
                /*
                 .always(function(jqXHR, statusText) {
                 //alert( "complete" );
                 var msg = parseAjaxResp(jqXHR);
                 logResponse("Response:", msg);
                 });
                 */
            }
            catch(e){
                logResponse("Exception", e);
            }
        });
    });

    //-------------------- CORS ----------------------------------//
    $("#CORSTest").on("click", function(){
        var arrUrls = getUrls();
        $.each(arrUrls, function(index, url){
            try{
                var xhr = new XMLHttpRequest(),
                        method = "GET";
                if ("withCredentials" in xhr) {

                    // Check if the XMLHttpRequest object has a "withCredentials" property.
                    // "withCredentials" only exists on XMLHTTPRequest2 objects.
                    xhr.open(method, url, true);

                } else if (typeof XDomainRequest != "undefined") {

                    // Otherwise, check if XDomainRequest.
                    // XDomainRequest only exists in IE, and is IE's way of making CORS requests.
                    xhr = new XDomainRequest();
                    xhr.open(method, url);

                } else {

                    // Otherwise, CORS is not supported by the browser.
                    logResponse("CORS-Test", "CORS is not supported by the browser");

                }

                //event handlers
                xhr.onload = function() {
                    var responseText = xhr.responseText;
                    logResponse("CORS-Test", responseText);
                    // process the response.

                    // dump the response headers
                    dumpHeaders(xhr);
                };

                xhr.onabort = function(XMLHttpRequestProgressEvent) {
                    logResponse("CORS-Test-Abort", XMLHttpRequestProgressEvent, true);
                };

                xhr.onerror = function(XMLHttpRequestProgressEvent) {
                    logResponse("CORS-Test-Error", XMLHttpRequestProgressEvent, true);
                };

                xhr.send();
            }
            catch(e){
                logResponse("Exception", e);
            }
        });//$.each
    });
    //-------------------------- image --------------------------------//
    $("#imageTest").on("click", function(){
        var arrUrls = getUrls();
        $.each(arrUrls, function(index, url){
            try{
                var img = new Image();
                img.onload = function (event) {
                    logResponse("Image Test-Loaded", event, true);
                    dumpImgInfo(this);
                };
                img.onerror = function (event) {
                    logResponse("Image Test-Err", event, true);
                    dumpImgInfo(this);
                };
                //img.src = url + '/onethatdoesnotexist.gif';
                img.src = url + '/favicon.ico';
            }
            catch(e){
                logResponse("Exception", e);
            }
        });
    });
    //--------------------------- iframe ------------------------------------------//
    $("#iframeTest").on("click", function(){
        var arrUrls = getUrls();


        $.each(arrUrls, function(index, url){
            try{
                var link = url, id = new Date().getTime();
                var iframe = document.createElement('iframe');
                iframe.id=id;
                iframe.setAttribute("src", link);
                document.body.appendChild(iframe);
                iframe.onload = function () {
                    try {
                        var resp = $("#" + id).contents()[0].body.innerHTML;
                        logResponse("iFrame-Test-Loaded", resp);
                        //$("#" + id).remove();
                    }
                    catch(e) {
                        logResponse("iFrame-Exception", e);
                    }
                    finally {
                        dumpIframeInfo(iframe);
                    }
                };
                iframe.onerror = function () {
                    logResponse("iFrame-Error", "Error!!!");
                    dumpIframeInfo(iframe);
                }
            }
            catch(e){
                logResponse("Exception", e);
            }
        });
    });
    //-------------------------- window.postMessage --------------------------------//

    //-------------------------- MessageChannel--------------------------------//

    //---------------------------- helpers ------------------------------------//
    $("#clearResults").on("click", function (){
        $("#response").empty();
        $("iframe").remove()
    });

    function getUrls(){
        var arrUrls = $("#urllist").val().split(",");
        return arrUrls;
    }
    function logResponse(hdr, msg, isObject){
        var msgTxt = msg;
        if(isObject){
            msgTxt = "";
            $.each(msg, function(key, val){
                msgTxt += key + "=" + val + "|";
            });
        }
        $("#response").append("<div class='results-row'><b><u>" + hdr + "</u></b><br>" + msgTxt + "</div>");
    }
    function objToString (obj) {
        var str = '';
        for (var p in obj) {
            if (obj.hasOwnProperty(p)) {
                str += p + '::' + obj[p] + '\n';
            }
        }
        return str;
    }

    function parseAjaxResp(resp){
        var msg = "";
        //msg += "|URL:" + resp.url || "";
        msg += "|readyState:" + resp.readyState;
        //msg += "|responseText:" + ($('<div/>').html(resp.responseText).text() || "none");
        msg += "|status:" + resp.status;
        msg += "|statusText:" + resp.statusText;
        //msg += "|responseText:" + (resp.responseText || "none");
        //msg += "|timeout:" + resp.timeout;
        return msg;
    }

    function clearResults(){
        $("#response").empty();
        $("iframe").remove()
    }

    function dumpHeaders(xhr)
    {
        var msg = "";
        if (xhr.getAllResponseHeaders) {
            var hdrs = xhr.getAllResponseHeaders();
            hdrs = hdrs.split('\r\n');
            var hdrCount = 0;
            for (var k = 0; k < hdrs.length; k++) {
                if (hdrs[k].trim().length == 0) {
                    continue;
                }
                hdrCount++;
            }
            if (hdrCount > 0) {
                msg += hdrs.join('|');
            }
            else {
                msg += 'No visible response header found';
            }
        }
        return msg;
    }

    function dumpImgInfo(elem)
    {
        // reference to document object
        var d = elem.ownerDocument;
        // reference to window object
        var win = d.defaultView || d.parentWindow;
        // reference to navigator object
        var nav = win.navigator;

        var infoArr = [];
        infoArr.push('Image Source = ' + elem.src);
        infoArr.push('Owner Document Domain = ' + d.domain);
        infoArr.push('Owner Document Referrer = ' + d.referrer);

        infoArr.push('User Agent = ' + nav.userAgent);
        infoArr.push('Browser = ' + nav.appName + ' ' + nav.appVersion);

        logResponse("IMG Owner Document Info", infoArr.join('<br>'));
    }

    function dumpIframeInfo(elem)
    {
        // reference to document object
        var d = elem.ownerDocument;
        // reference to window object
        var win = d.defaultView || d.parentWindow;
        // reference to navigator object
        var nav = win.navigator;

        var infoArr = [];
        infoArr.push('Owner Document Domain = ' + d.domain);
        infoArr.push('Owner Document Referrer = ' + d.referrer);

        infoArr.push('User Agent = ' + nav.userAgent);
        infoArr.push('Browser = ' + nav.appName + ' ' + nav.appVersion);

        logResponse("IFrame Owner Document Info", infoArr.join('<br>'));
    }


});//on ready
</script>
</head>
<body>

<div id="main">

    <label>Paste URLs below (comma sperated) to append to Test URLs:</label>
    <textarea class="panel panel-default" id="urllist" style="width:100%;height:100px;"></textarea>

    <div class="panel panel-default" id="toolbar" style="border-width: 0px; margin: 10px;">
        <!--
         Test using:&nbsp;
                <button class="btn btn-primary" id="JSONPTest">JSONP</button>
                <button class="btn btn-primary"  id="ajaxTest">Ajax</button>
                <button class="btn btn-primary"  id="CORSTest">CORS</button>
                <button class="btn btn-primary"  id="imageTest">Image Download</button>
                <button class="btn btn-primary"  id="iframeTest">iFrame</button>
        -->
        <button class="btn btn-primary"  id="urlLooper">Start URL Audit</button>

        <button class="btn btn-danger" id="clearResults">Clear Results</button>
    </div>

    <div class="panel panel-default" id="response"></div>


</div>

</body>
</html>
